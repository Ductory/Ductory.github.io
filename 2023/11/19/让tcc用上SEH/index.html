<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>让tcc用上SEH | Ductory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="本文将简要地介绍SEH最基础的内容以及tcc自带的SEH，并用宏为tcc实现一个类VC6的try-except-finally扩展和一个try-catch-finally扩展。">
<meta property="og:type" content="article">
<meta property="og:title" content="让tcc用上SEH">
<meta property="og:url" content="https://ductory.github.io/2023/11/19/%E8%AE%A9tcc%E7%94%A8%E4%B8%8ASEH/index.html">
<meta property="og:site_name" content="Ductory">
<meta property="og:description" content="本文将简要地介绍SEH最基础的内容以及tcc自带的SEH，并用宏为tcc实现一个类VC6的try-except-finally扩展和一个try-catch-finally扩展。">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-11-19T06:17:23.000Z">
<meta property="article:modified_time" content="2024-04-30T16:02:11.653Z">
<meta property="article:author" content="Dangfer">
<meta property="article:tag" content="C">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Ductory" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"><link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Ductory</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <div class="search-form">
          <input type="text" id="site-search-input" class="search-form-input" placeholder="">
        </div>
      </div>
        <div id="site-search-result"></div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-让tcc用上SEH" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/11/19/%E8%AE%A9tcc%E7%94%A8%E4%B8%8ASEH/" class="article-date">
  <time class="dt-published" datetime="2023-11-19T06:17:23.000Z" itemprop="datePublished">2023-11-19</time>
  <time class="dt-updated" datetime="2024-04-30T16:02:11.653Z" itemprop="dateUpdated">
     (UPDATED 2024-05-01)
  </time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      让tcc用上SEH
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2>
<ol>
<li>
<p>本文不建议初学者阅读。</p>
</li>
<li>
<p>本文将涉及少量汇编，请确保你已经了解x86汇编的基础知识。</p>
</li>
<li>
<p>确保你已经了解异常处理的基础知识。</p>
</li>
</ol>
<p>tcc(Tiny C Compiler)是Fabrice Bellard大佬用C和汇编实现的一个的C语言编译器，可自举并支持部分GCC扩展。并不建议在学习或生产中使用tcc，因为它有着较多缺陷，譬如switch的作用域处理有问题，asm的&quot;=q&quot;未正常弹栈，vm类型大小分析错误，等等。同时，它对C99的支持也不完善，它并不支持C99的复数类型。比起一个工具，它更像是一个玩具。</p>
<p>本文使用的tcc版本：tcc version 0.9.27 (i386 Windows)。</p>
<h2 id="seh简介"><a class="markdownIt-Anchor" href="#seh简介"></a> SEH简介</h2>
<p>在开始之前，我们先简要地介绍一下SEH。SEH，顾名思义，就是<strong>结构化异常处理</strong>(Structured Exception Handling)。</p>
<p>当线程出现错误时，操作系统调用用户定义的回调函数来处理这个错误。回调函数长这样：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXCEPTION_DISPOSITION __cdecl <span class="title function_">except_handler</span><span class="params">(PEXCEPTION_RECORD record, PEXCEPTION_REGISTRATION frame, PCONTEXT context, <span class="type">void</span> *dispatcher)</span>;</span><br></pre></td></tr></table></figure>
<p><code>record</code>包含了异常的一些重要信息，包括异常代码、异常标志、发生异常时的地址，等等。</p>
<p><code>frame</code>非常重要，我们稍后提及，并围绕它逐步深入。</p>
<p><code>context</code>包含了异常发生时寄存器的值。</p>
<p><code>dispatcher</code>会涉及比较深入的内容，由于本文仅介绍SEH最基础的内容，所以我们忽略它，把它当做保留参数即可。</p>
<p>当线程发生错误时，操作系统如何知道去哪调用异常处理例程呢？答案是<strong>线程信息块</strong>(TIB, Thread Information Block)。TIB的第一个成员指向了一个<code>EXCEPTION_REGISTRATION</code>结构，它的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION</span> &#123;</span></span><br><span class="line">  PEXCEPTION_REGISTRATION prev;</span><br><span class="line">  PEXCEPTION_HANDLER handler;</span><br><span class="line">&#125; EXCEPTION_REGISTRATION, *PEXCEPTION_REGISTRATION;</span><br></pre></td></tr></table></figure>
<p>注意，这里是<strong>有语法错误</strong>的。但为了简洁起见，我们忽略这个错误。后同不述。</p>
<p><code>prev</code>事实上还有写成<code>next</code>的，但是我更倾向于写成<code>prev</code>。它指向了前一个<code>EXCEPTION_REGISTRATION</code>。事实上，这是一个链表，每一个结点都给出了一个异常处理例程，而TIB的第一个成员便是这个链表的头结点。</p>
<p><code>handler</code>是异常处理例程，每个函数可以根据异常代码选择是否处理该异常，并通过返回值来指示接下来应当进行何种操作。</p>
<p>在<code>winnt.h</code>中，这个结构被称为<code>EXCEPTION_REGISTRATION_RECORD</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span> &#123;</span></span><br><span class="line">  PEXCEPTION_REGISTRATION_RECORD ExceptionList;</span><br><span class="line">  PVOID StackBase;</span><br><span class="line">  PVOID StackLimit;</span><br><span class="line">  PVOID SubSystemTib;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    PVOID FiberData;</span><br><span class="line">    DWORD Version;</span><br><span class="line">  &#125;;</span><br><span class="line">  PVOID ArbitraryUserPointer;</span><br><span class="line">  PNT_TIB Self;</span><br><span class="line">&#125; NT_TIB, *PNT_TIB;</span><br></pre></td></tr></table></figure>
<p>那么我们又应当在哪里去找TIB呢？答案是<code>FS</code>段寄存器，<code>FS</code>段的首地址即存放着该线程的TIB，因此<code>fs:[0]</code>便是<code>EXCEPTION_REGISTARTION</code>的地址。</p>
<p>虽说我们不怎么涉及<strong>展开</strong>(Unwinding)，但是若不介绍似乎又有些缺憾，这里非常简要地介绍一下：</p>
<p>我们知道，异常发生时，操作系统遍历<code>EXCEPTION_REGISTARTION</code>结构链表，直到有一个函数处理了这个异常。此时，操作系统再次遍历链表，并将<code>ExceptionRecord</code>中的异常标志设置为<code>EH_UNWINDING</code>。它为异常处理例程提供清理的机会。</p>
<p>好了，说了这么多，相信读者已经差不多头晕了。但事实上，这只是SEH中最基础的内容，本文还有相当多的细节未提及，但我们先放下它，因为这些内容已经足够阅读本文了。关于SEH更详细的内容可以查阅参考文献<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>。</p>
<h2 id="使用tcc自带的seh"><a class="markdownIt-Anchor" href="#使用tcc自带的seh"></a> 使用tcc自带的SEH</h2>
<p>众所周知，tcc确实已经为我们提供了简单的SEH支持。tcc提供了一个<code>__TRY__</code>宏，它被定义在<code>_mingw.h</code>。它为我们构造的try-except块长这样：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__try &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line">__except (_XcptFilter(GetExceptionCode(), GetExceptionInformation())) &#123;</span><br><span class="line">    <span class="built_in">exit</span>(GetExceptionCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个宏被用于tcc的start函数（即在调用main之前的thunk函数），包括<code>_tstart</code>、<code>_twinstart</code>以及对应的run版本。</p>
<p>细心的读者可能就会发现了，是的，它与VC6的start函数的try-except块神似。</p>
<p>但是有些人就会说了，要是每个try-except都长一样的话那也没啥用啊。是的，tcc事实上还提供了两个宏，见<code>excpt.h</code>。其中，<code>__try1</code>宏用于构造异常处理帧，而<code>__except1</code>宏用于移除异常处理帧。我们来看一下这两个宏：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __try1(pHandler) \</span></span><br><span class="line"><span class="meta">  __asm__ (<span class="string">&quot;pushl %0;pushl %%fs:0;movl %%esp,%%fs:0;&quot;</span> : : <span class="string">&quot;g&quot;</span> (pHandler));</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	__except1	\</span></span><br><span class="line"><span class="meta">  __asm__ (<span class="string">&quot;movl (%%esp),%%eax;movl %%eax,%%fs:0;addl $8,%%esp;&quot;</span> \</span></span><br><span class="line"><span class="meta">  : : : <span class="string">&quot;%eax&quot;</span>);</span></span><br></pre></td></tr></table></figure>
<p>我们解释一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">; __try1</span><br><span class="line">push handler ;异常处理例程</span><br><span class="line">push dword ptr fs:[0] ;从fs:[0]获取前一个结构</span><br><span class="line">mov fs:[0], esp ;安装SEH</span><br><span class="line">;__except1</span><br><span class="line">mov eax, [esp] ;获取前一个结构</span><br><span class="line">mov fs:[0], eax ;安装前一个结构</span><br><span class="line">add esp, 8 ;恢复堆栈</span><br></pre></td></tr></table></figure>
<p>比较搞笑的是，当你使用<code>__except1</code>时会报错：<code>error: invalid clobber register '%eax'</code>。这是因为tcc不支持这种写法，所以得把<code>%eax</code>的<code>%</code>给去掉。</p>
<p>好了，现在我们可以自己写一个函数，用<code>__try1</code>注册异常处理例程，并用<code>__except1</code>卸载，我们写一个简单的demo：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;excpt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">EXCEPTION_DISPOSITION</span><br><span class="line"><span class="title function_">handler</span><span class="params">(PEXCEPTION_RECORD record, PEXCEPTION_REGISTRATION frame,</span></span><br><span class="line"><span class="params">    PCONTEXT context,<span class="type">void</span> *dispatcher)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (record-&gt;ExceptionCode == EXCEPTION_ACCESS_VIOLATION)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;access violation at %p\n&quot;</span>, record-&gt;ExceptionAddress);</span><br><span class="line">    <span class="keyword">return</span> ExceptionContinueSearch; <span class="comment">// 不处理</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    __try1(handler)</span><br><span class="line">    <span class="type">int</span> n = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, n);</span><br><span class="line">    __except1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个demo里，由于<code>scanf</code>中故意没写取址符，因此在尝试向0地址写入内容时会触发一个<code>EXCEPTION_ACCESS_VIOLATION</code>异常，被我们的异常处理例程捕获，打印提示信息后继续让其他处理程序去处理异常。</p>
<p>我们还可以用这两个宏来做一些更有趣的事情，比如实现一个简单的反调试手段：通过设置<code>TF</code>标志位来让程序产生单步断点，在产生单步异常后，我们用异常处理例程处理异常发生地址的内容来实现代码的动态加解密。</p>
<p>如果诸位吃饱了撑着可以尝试一下我写的一个简单的注册机demo，源代码和解析会放在文章的最后。</p>
<h2 id="扩展seh"><a class="markdownIt-Anchor" href="#扩展seh"></a> 扩展SEH</h2>
<p><span style='color:red'>这里是之前的内容，是try-except-finally的实现，并不好用，且更为复杂。不感兴趣的话可以直接转到<strong>更简单的SEH宏</strong>。</span></p>
<p>也许有人会说，SEH的作用实在有限啊，这样怎么实现try-except-finally？事实上这是因为基本的SEH帧包含的信息太少了，我们只需扩展一下<code>EXCEPTION_REGISTRATION</code>结构，便能做很多事情了。接下来让我们扩展这个结构并先实现类VC的try-except扩展，然后再实现try-except-finally。</p>
<p>在上文，我们用<code>__try1</code>和<code>__except1</code>来安装任意的异常处理例程。然而在VC6里，try-except事实上只使用了一个异常处理例程，那就是<code>_except_handler3</code>。</p>
<p>我们先来看一下VC6使用的扩展<code>EXCEPTION_REGISTRATION</code>结构。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EH3_EXCEPTION_REGISTRATION</span> &#123;</span></span><br><span class="line">    <span class="comment">//-8 void *_esp;</span></span><br><span class="line">    <span class="comment">//-4 PEXCEPTION_POINTERS xpointers;</span></span><br><span class="line">    PVC_EXCEPTION_REGISTRATION prev;</span><br><span class="line">    PEXCEPTION_HANDLER handler;</span><br><span class="line">    PSCOPETABLE scopetable;</span><br><span class="line">    <span class="type">int</span> trylevel;</span><br><span class="line">    <span class="type">void</span> *_ebp;</span><br><span class="line">&#125; EH3_EXCEPTION_REGISTRATION, *PEH3_EXCEPTION_REGISTRATION;</span><br></pre></td></tr></table></figure>
<p><code>prev</code>和<code>handler</code>就是之前的<code>EXCEPTION_REGISTRATION</code>成员。</p>
<p><code>_esp</code>和<code>_ebp</code>也很好理解，就是这两个寄存器的值。</p>
<p><code>xpointers</code>用于保存在异常发生时<code>_except_handler3</code>传回的异常信息，<code>EXCEPTION_POINTERS</code>的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_POINTERS</span> &#123;</span></span><br><span class="line">    PEXCEPTION_RECORD record;</span><br><span class="line">    PCONTEXT context;</span><br><span class="line">&#125; EXCEPTION_POINTERS, *PEXCEPTION_POINTERS;</span><br></pre></td></tr></table></figure>
<p>关于<code>scoptable</code>和<code>trylevel</code>，我们将在稍后进行讲解，现在我们仅给出<code>SCOPETABLE</code>的结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SCOPETABLE</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> prev;</span><br><span class="line">    FARPROC filter;</span><br><span class="line">    FARPROC handler;</span><br><span class="line">&#125; SCOPETABLE, *PSCOPETABLE;</span><br></pre></td></tr></table></figure>
<p>要想弄明白<code>scoptable</code>和<code>trylevel</code>，我想可能需要理解一下<code>_except_handler3</code>。伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">EXCEPTION_DISPOSITION</span><br><span class="line">_except_handler3(PEXCEPTION_RECORD record, PEH3EXCEPTION_REGISTRATION frame,</span><br><span class="line">	PCONTEXT context,<span class="type">void</span> *dispatcher)</span><br><span class="line">&#123;</span><br><span class="line">    CLD</span><br><span class="line">    <span class="title function_">if</span> <span class="params">(!(record-&gt;ExceptionFlags &amp; (EXCEPTION_UNWINDING | EXCEPTION_EXIT_UNWIND)))</span> &#123;</span><br><span class="line">        EXCEPTION_POINTERS xpointers = &#123;record, context&#125;;</span><br><span class="line">        frame-&gt;xpointers = xpointers; <span class="comment">// 传回异常信息</span></span><br><span class="line">        <span class="type">int</span> trylevel = frame-&gt;trylevel;</span><br><span class="line">        PSCOPETABLE scopetable = frame-&gt;scopetable;</span><br><span class="line">        <span class="keyword">while</span> (trylevel != TRYLEVEL_NONE) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scopetable[trylevel].filter) &#123;</span><br><span class="line">                PUSH ESI</span><br><span class="line">                PUSH EBP</span><br><span class="line">                EBP = &amp;frame-&gt;_ebp; <span class="comment">// 恢复异常前的栈帧</span></span><br><span class="line">                <span class="type">int</span> ret = scopetable[trylevel].filter();</span><br><span class="line">                POP EBP</span><br><span class="line">                POP ESI</span><br><span class="line">                <span class="title function_">if</span> <span class="params">(ret != EXCEPTION_CONTINUE_SEARCH)</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) <span class="comment">// EXCEPTION_CONTINUE_EXECUTION</span></span><br><span class="line">                        <span class="keyword">return</span> ExceptionContinueExecution;</span><br><span class="line">                    <span class="comment">// EXCEPTION_EXECUTE_HANDLER</span></span><br><span class="line">                    <span class="comment">// 这里必须手动执行展开，因为在调用handler后不会返回</span></span><br><span class="line">                    _global_unwind2(frame);</span><br><span class="line">                    EBP = &amp;frame-&gt;_ebp;</span><br><span class="line">                    _local_unwind2(frame, trylevel);</span><br><span class="line">                    _NLG_Notify(<span class="number">1</span>);</span><br><span class="line">                    frame-&gt;trylevel = scopetable[trylevel].prev;</span><br><span class="line">                    scopetable[trylevel].handler(); <span class="comment">// noreturn</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            trylevel = scopetable[trylevel].prev;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// unwind</span></span><br><span class="line">        PUSH EBP</span><br><span class="line">        EBP = &amp;frame-&gt;_ebp;</span><br><span class="line">        _local_unwind2(frame, TRYLEVEL_NONE);</span><br><span class="line">        POP EBP</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ExceptionContinueSearch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相信大家看完这段伪代码就明白<code>scopetable</code>和<code>trylevel</code>的作用是什么了。</p>
<p><code>prev</code>用来实现嵌套的try-except，每层<code>scope</code>的<code>prev</code>均为前一层的索引，最外层的<code>scope</code>的<code>prev</code>为<code>TRYLEVEL_NONE</code>。</p>
<p><code>filter</code>是一个函数指针，<code>_except_handler3</code>调用它来决定是不处理异常、重新执行原来的指令还是执行<code>handler</code>。是的，虽然它写在<code>__except</code>后面的括号里，但它并不是个表达式。</p>
<p><code>handler</code>也是一个函数指针。但不同于<code>filter</code>的是，<code>_except_handler3</code>在调用<code>handler</code>后并不会返回，这有些类似于<code>longjmp</code>。当<code>filter</code>返回<code>EXCEPTION_EXECUTE_HANDLER</code>时，<code>_except_handler3</code>会调用<code>handler</code>，也就是<code>__except</code>花括号里的内容。</p>
<p>好了，说了这么多，我们总算把VC的扩展<code>EXCEPTION_REGISTRATION</code>给介绍完了，现在我们终于可以开始为tcc编写try-except扩展了。</p>
<h2 id="为tcc编写try-except扩展"><a class="markdownIt-Anchor" href="#为tcc编写try-except扩展"></a> 为tcc编写try-except扩展</h2>
<p>我们都知道，tcc会这样构造栈帧：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">push ebp</span><br><span class="line">mov ebp,esp</span><br><span class="line">sub esp,XXX</span><br><span class="line">nop</span><br><span class="line">;...</span><br><span class="line">pop ebp</span><br><span class="line">leave</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>我们发现tcc似乎没有给我们留下操作空间，我们既不能直接通过push指令来构造异常处理帧，也不能通过<code>EBP</code>的偏移来构造异常处理帧，因为我们会占用自动变量的空间。但事实真是如此吗？我们还知道tcc这样一个特性，<strong>自动变量在堆栈上的空间严格按照其在函数中定义的顺序</strong>。如此一来，我们只要在函数的开头定义一个充足大小的自动变量即可。故而我们可以很容易写出如下宏来构造和移除异常处理帧：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __seh_begin void *_seh[6]; \</span></span><br><span class="line"><span class="meta">    asm( \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl $-1,-4(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%eax,-8(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl $_except_handler3,-12(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%fs:0,%%eax;&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%eax,-16(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%esp,-24(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;leal -16(%%ebp),%%eax;&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%eax,%%fs:0;&quot;</span>: :<span class="string">&quot;a&quot;</span>(_scopetable));</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __seh_end asm( \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl -16(%%ebp),%%eax;movl %%eax,%%fs:0;&quot;</span>: : :<span class="string">&quot;eax&quot;</span>);</span></span><br></pre></td></tr></table></figure>
<p>现在还有一个问题：<code>_scopetable</code>还没处理。有一点是毫无疑问的，<code>_scopetable</code>需要我们手动构造，确实比较麻烦。所以我们来简化一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">scope</span> &#123;</span><span class="type">int</span> trylevel; <span class="type">void</span> *filter, *handler;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __seh_scope static struct _scope _scopetable[] =</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __scope(l,i) &#123;l, &amp;&amp;_filter ## i, &amp;&amp;_handler ## i&#125;</span></span><br></pre></td></tr></table></figure>
<p>如果要写出类似try-except的结构，那就要知道filter和handler的地址，所以我们需要GNU C扩展<code>&amp;&amp;</code>来获取label的地址；要实现嵌套scope，我们又不得不为每个label编号。</p>
<p>一通折腾，我们总算能做出scopetable了。我们写出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    __seh_scope &#123;</span><br><span class="line">        __scope(<span class="number">-1</span>, <span class="number">0</span>), __scope(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    &#125;;</span><br><span class="line">    __seh_begin</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    __seh_end</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看上去非常不错。虽然做了很多妥协，但似乎也不是不能接受。</p>
<p>接下来我们来实现<code>__try</code>、<code>__except</code>和<code>__leave</code>。至于<code>__finally</code>，我们先放在一边。</p>
<p>我们写出以下宏：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __try asm(<span class="string">&quot;incl -4(%ebp)&quot;</span>); do</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __except(i,f) while (0); __leave(i); \</span></span><br><span class="line"><span class="meta">    _filter ## i: \</span></span><br><span class="line"><span class="meta">    asm(<span class="string">&quot;ret&quot;</span>: :<span class="string">&quot;a&quot;</span>((&#123;f;&#125;))); \</span></span><br><span class="line"><span class="meta">    _handler ## i: do</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __end(i) while (0); _end ## i: ;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __leave(i) asm(<span class="string">&quot;decl -4(%ebp)&quot;</span>); goto _end ## i</span></span><br></pre></td></tr></table></figure>
<p>每次进入try块时，<code>frame.trylevel</code>加1。在try块正常结束后，将其减1来表示回到上一层scope。</p>
<p><code>__except</code>定义了两个标签，i为标签索引，f为filter语句。因为<code>scope.filter</code>只需是一个函数指针，我们不妨用GNU C扩展<strong>复合语句表达式</strong>来将语句转为表达式。</p>
<p><code>__end</code>只是定义了一个标签。</p>
<p><code>__leave</code>也很好理解，恢复trylevel并跳到对应的<code>__end</code>处。</p>
<p>如果你还没有头晕，那么就让我们继续吧！我们写出这样一个demo：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    __seh_scope &#123;</span><br><span class="line">        __scope(<span class="number">-1</span>, <span class="number">0</span>), __scope(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    &#125;;</span><br><span class="line">    __seh_begin</span><br><span class="line"></span><br><span class="line">    __try &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;success\n&quot;</span>);</span><br><span class="line">        __try &#123;</span><br><span class="line">            *(<span class="type">int</span>*)<span class="number">0</span> = <span class="number">1</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;success2\n&quot;</span>);</span><br><span class="line">        &#125; __except(<span class="number">1</span>,EF_HANDLE) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;catch2\n&quot;</span>);</span><br><span class="line">        &#125; __end(<span class="number">1</span>)</span><br><span class="line">    &#125; __except(<span class="number">0</span>,EF_HANDLE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;catch\n&quot;</span>);</span><br><span class="line">    &#125; __end(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    __try &#123;</span><br><span class="line">        __leave(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello\n&quot;</span>);</span><br><span class="line">    &#125; __except(<span class="number">2</span>,EF_SEARCH) &#123;</span><br><span class="line">        ;</span><br><span class="line">    &#125; __end(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    __seh_end</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    foo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为我懒，嫌EXCEPTION_的宏常量实在太长，所以自己又定义了一遍短版本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EF_EXECUTE (-1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EF_SEARCH 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EF_HANDLE 1</span></span><br></pre></td></tr></table></figure>
<p>看起来一切准备就绪，让我们开始运行吧！</p>
<p>然后，我们发现，handler并没有被执行。惊不惊喜，意不意外？这是因为<code>_except_handler3</code>会调用<code>_ValidateEH3RN</code>进行安全性检查，它要求<strong>scopetable必须对齐且放在只读节</strong>。</p>
<p>那把它放在.rdata节不就行了吗？不行，因为tcc的.rdata节是可写的！那放在.text节又怎么样呢？也不行，因为tcc的神奇特性（bug），它虽然会将scopetable放在.text节，但是由于我们在函数内定义了它（虽然是static），代码会直接覆盖scopetable！</p>
<p>难道我们就没有办法了吗？把scopetable放在函数外面？虽然可行（没错，tcc又一个诡异特性，label在它所在的函数定义前是可见的），但是宏将被改写得十分麻烦。</p>
<p>那么，打开tccpe.c，我们看到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> DWORD pe_sec_flags[] = &#123;</span><br><span class="line">    <span class="number">0x60000020</span>, <span class="comment">/* &quot;.text&quot;     , */</span></span><br><span class="line">    <span class="number">0xC0000040</span>, <span class="comment">/* &quot;.data&quot;     , */</span></span><br><span class="line">    <span class="number">0xC0000080</span>, <span class="comment">/* &quot;.bss&quot;      , */</span></span><br><span class="line">    <span class="number">0x40000040</span>, <span class="comment">/* &quot;.idata&quot;    , */</span></span><br><span class="line">    <span class="number">0x40000040</span>, <span class="comment">/* &quot;.pdata&quot;    , */</span></span><br><span class="line">    <span class="number">0xE0000060</span>, <span class="comment">/* &lt; other &gt;   , */</span></span><br><span class="line">    <span class="number">0x40000040</span>, <span class="comment">/* &quot;.rsrc&quot;     , */</span></span><br><span class="line">    <span class="number">0x42000802</span>, <span class="comment">/* &quot;.stab&quot;     , */</span></span><br><span class="line">    <span class="number">0x42000040</span>, <span class="comment">/* &quot;.reloc&quot;    , */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这些flags便是节的flags了。我们再来看看<code>pe_section_class</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">pe_section_class</span><span class="params">(Section *s)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> type, flags;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line"></span><br><span class="line">    type = s-&gt;sh_type;</span><br><span class="line">    flags = s-&gt;sh_flags;</span><br><span class="line">    name = s-&gt;name;</span><br><span class="line">    <span class="keyword">if</span> (flags &amp; SHF_ALLOC) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == SHT_PROGBITS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (flags &amp; SHF_EXECINSTR)</span><br><span class="line">                <span class="keyword">return</span> sec_text;</span><br><span class="line">            <span class="keyword">if</span> (flags &amp; SHF_WRITE)</span><br><span class="line">                <span class="keyword">return</span> sec_data;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strcmp</span>(name, <span class="string">&quot;.rsrc&quot;</span>))</span><br><span class="line">                <span class="keyword">return</span> sec_rsrc;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strcmp</span>(name, <span class="string">&quot;.iedat&quot;</span>))</span><br><span class="line">                <span class="keyword">return</span> sec_idata;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strcmp</span>(name, <span class="string">&quot;.pdata&quot;</span>))</span><br><span class="line">                <span class="keyword">return</span> sec_pdata;</span><br><span class="line">            <span class="keyword">return</span> sec_other;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == SHT_NOBITS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (flags &amp; SHF_WRITE)</span><br><span class="line">                <span class="keyword">return</span> sec_bss;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strcmp</span>(name, <span class="string">&quot;.reloc&quot;</span>))</span><br><span class="line">            <span class="keyword">return</span> sec_reloc;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(name, <span class="string">&quot;.stab&quot;</span>, <span class="number">5</span>)) <span class="comment">/* .stab and .stabstr */</span></span><br><span class="line">            <span class="keyword">return</span> sec_stab;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在此我们便可以解释.rdata为何可写了。由于没有.rdata，所以它被归为other，也就是可RWE，且包含代码和初始化数据，自然也就无法通过检查了。</p>
<p>基于上述分析，我们略微修改<code>__seh_scope</code>宏：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __seh_scope static __attribute__((section(<span class="string">&quot;.pdata&quot;</span>))) \</span></span><br><span class="line"><span class="meta">	struct _scope _scopetable[] =</span></span><br></pre></td></tr></table></figure>
<p>让我们再次运行，终于成功了！</p>
<p>那么，我们还差最后一样东西：<code>throw</code>。虽说它不属于try-except，但是管它呢，我们直接简单地封装一下<code>RaiseException</code>即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define throw(code) RaiseException(code, 0, 0, NULL)</span><br></pre></td></tr></table></figure>
<p>也可以修改<code>RaiseException</code>的第3、4个参数来传递额外的信息，来实现功能更强的<code>throw</code>。</p>
<p>让我们重新整理一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _TCCSEH_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _TCCSEH_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NULL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NULL ((void *)0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _WINBASE_</span></span><br><span class="line"><span class="type">void</span> __stdcall <span class="title function_">RaiseException</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> dwExceptionCode, <span class="type">unsigned</span> <span class="type">long</span> dwExceptionFlags, <span class="type">int</span> nNumberOfArguments, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> *lpArguments)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _INC_EXCPT</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> __cdecl _exception_code(<span class="type">void</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __seh_begin void *_seh[6]; \</span></span><br><span class="line"><span class="meta">    asm( \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl $-1,-4(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%eax,-8(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl $_except_handler3,-12(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%fs:0,%%eax;&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%eax,-16(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%esp,-24(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;leal -16(%%ebp),%%eax;&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%eax,%%fs:0;&quot;</span>: :<span class="string">&quot;a&quot;</span>(_scopetable));</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __seh_end asm( \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl -16(%%ebp),%%eax;movl %%eax,%%fs:0;&quot;</span>: : :<span class="string">&quot;eax&quot;</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">scope</span> &#123;</span><span class="type">int</span> trylevel; <span class="type">void</span> *filter, *handler;&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __seh_scope static __attribute__((section(<span class="string">&quot;.pdata&quot;</span>))) struct _scope _scopetable[] =</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __scope(l,i) &#123;l, &amp;&amp;_filter ## i, &amp;&amp;_handler ## i&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __try asm(<span class="string">&quot;incl -4(%ebp)&quot;</span>); do</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __except(i,f...) while (0); __leave(i); \</span></span><br><span class="line"><span class="meta">    _filter ## i: \</span></span><br><span class="line"><span class="meta">    asm(<span class="string">&quot;ret&quot;</span>: :<span class="string">&quot;a&quot;</span>((&#123;f;&#125;))); \</span></span><br><span class="line"><span class="meta">    _handler ## i: do</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __end(i) while (0); _end ## i: ;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __leave(i) asm(<span class="string">&quot;decl -4(%ebp)&quot;</span>); goto _end ## i</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> throw(code) RaiseException(code, 0, 0, NULL)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EF_EXECUTE (-1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EF_SEARCH 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EF_HANDLE 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这样，我们就成功实现了类VC的try-except扩展了。</p>
<h2 id="加上finally"><a class="markdownIt-Anchor" href="#加上finally"></a> 加上finally</h2>
<p>好了，现在我们重新捡起我们扔在一边的<code>__finally</code>。事实上，由于<code>__except</code>和<code>__finally</code>的实现机制不同，加上<code>__finally</code>将使得我们的宏无法共用。所以，我们不得不为它们制定两套宏。但是，如此一来，意义便不大了。因此，我们仅在此处介绍<code>_except_handler3</code>的<code>__finally</code>实现机制，而不为其编写<code>__finally</code>宏。</p>
<p>我们只需知道，<code>__finally</code>的实现是通过展开来实现的。在<code>_except_handler3</code>找到处理异常的<code>handler</code>时，调用<code>_local_unwind2</code>执行展开。这个函数会遍历<code>scopetable</code>，当<code>filter</code>为<code>NULL</code>时，异常处理例程会将<code>handler</code>成员当作<code>__finally</code>块执行。</p>
<p>如何尽可能简单地加上<code>__finally</code>呢？一个简单的思路便是抛弃<code>_except_handler3</code>，我们重新构造<code>scopetable</code>。</p>
<p>我们定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SCOPETABLE</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> prev;</span><br><span class="line">    <span class="type">void</span> *filter;</span><br><span class="line">    <span class="type">void</span> *handler;</span><br><span class="line">    <span class="type">void</span> *unwind;</span><br><span class="line">&#125; SCOPETABLE, *PSCOPETABLE;</span><br></pre></td></tr></table></figure>
<p>很容易写出以下汇编代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line"></span><br><span class="line">.global _tcc_except_handler</span><br><span class="line">// cdecl: record, frame, context, dispatcher_context</span><br><span class="line">_tcc_except_handler:</span><br><span class="line">	push %ebp</span><br><span class="line">	mov %esp,%ebp</span><br><span class="line">	sub $8,%esp</span><br><span class="line">	push %ebx</span><br><span class="line">	push %esi</span><br><span class="line">	push %edi</span><br><span class="line"></span><br><span class="line">	cld</span><br><span class="line">// frame</span><br><span class="line">	mov 12(%ebp),%ebx</span><br><span class="line">// record</span><br><span class="line">	mov 8(%ebp),%eax</span><br><span class="line">// ExceptionFlags &amp; (EXCEPTION_UNWINDING | EXCEPTION_EXIT_UNWIND)</span><br><span class="line">	testl $6,4(%eax)</span><br><span class="line">	jnz _unwinding</span><br><span class="line">// ptrs = &#123;record, context&#125;</span><br><span class="line">	mov %eax,-8(%ebp)</span><br><span class="line">	mov 16(%ebp),%eax</span><br><span class="line">	mov %eax,-4(%ebp) </span><br><span class="line">// xpointers</span><br><span class="line">	lea -8(%ebp),%eax</span><br><span class="line">	mov %eax,-4(%ebx)</span><br><span class="line">// trylevel</span><br><span class="line">	mov 12(%ebx),%esi</span><br><span class="line">// scopetable</span><br><span class="line">	mov 8(%ebx),%edi</span><br><span class="line">_traverse:</span><br><span class="line">	cmp $-1,%esi</span><br><span class="line">	je _continue_search</span><br><span class="line">	shl $4,%esi</span><br><span class="line">// filter</span><br><span class="line">	cmpl $0,4(%edi,%esi)</span><br><span class="line">	je _go_prev</span><br><span class="line">	push %esi</span><br><span class="line">	push %ebp</span><br><span class="line">	lea 16(%ebx),%ebp</span><br><span class="line">	call *4(%edi,%esi)</span><br><span class="line">	pop %ebp</span><br><span class="line">	pop %esi</span><br><span class="line"></span><br><span class="line">	or %eax, %eax</span><br><span class="line">	je _go_prev</span><br><span class="line">	js _continue_excution</span><br><span class="line">	mov 8(%ebx),%edi</span><br><span class="line">	push %ebx</span><br><span class="line">	call _global_unwind2</span><br><span class="line">	pop %ecx</span><br><span class="line">	lea 16(%ebx),%ebp</span><br><span class="line">	mov %esi,%eax</span><br><span class="line">	shr $4,%eax</span><br><span class="line">	push %eax</span><br><span class="line">	push %ebx</span><br><span class="line">	call _tcc_local_unwind</span><br><span class="line">// we discard __NLG_Notify</span><br><span class="line">	mov (%edi,%esi),%eax</span><br><span class="line">	mov %eax,12(%ebx)</span><br><span class="line">	call *8(%edi,%esi)</span><br><span class="line">_go_prev:</span><br><span class="line">	mov 8(%ebx),%edi</span><br><span class="line">	mov (%edi,%esi),%esi</span><br><span class="line">	jmp _traverse</span><br><span class="line">_continue_excution:</span><br><span class="line">	mov $0,%eax</span><br><span class="line">	jmp _eh_ret</span><br><span class="line">_unwinding:</span><br><span class="line">	push %ebp</span><br><span class="line">	lea 16(%ebx),%ebp</span><br><span class="line">	push $-1</span><br><span class="line">	push %ebx</span><br><span class="line">	call _tcc_local_unwind</span><br><span class="line">	pop %ebp</span><br><span class="line">_continue_search:</span><br><span class="line">	mov $1,%eax</span><br><span class="line">_eh_ret:</span><br><span class="line">	pop %edi</span><br><span class="line">	pop %esi</span><br><span class="line">	pop %ebx</span><br><span class="line">	leave</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// stacall: frame, trylvel</span><br><span class="line">_tcc_local_unwind:</span><br><span class="line">	push %ebx</span><br><span class="line">	push %esi</span><br><span class="line">	push %edi</span><br><span class="line">	push $_local_unwind_eh</span><br><span class="line">	pushl %fs:0</span><br><span class="line">	mov %esp,%fs:0</span><br><span class="line">_lu_t:</span><br><span class="line">	mov 24(%esp),%eax</span><br><span class="line">// scopetable</span><br><span class="line">	mov 8(%eax),%ebx</span><br><span class="line">// trylevel</span><br><span class="line">	mov 12(%eax),%esi</span><br><span class="line">	cmp $-1,%esi</span><br><span class="line">	je _lu_ret</span><br><span class="line">	cmpl 28(%esp),%esi</span><br><span class="line">	je _lu_ret</span><br><span class="line">	shl $4,%esi</span><br><span class="line">	mov (%ebx,%esi),%ecx</span><br><span class="line">	mov %ecx,12(%eax)</span><br><span class="line">	call *12(%ebx,%esi)</span><br><span class="line">	jmp _lu_t</span><br><span class="line">_lu_ret:</span><br><span class="line">	popl %fs:0</span><br><span class="line">	pop %ecx</span><br><span class="line">	pop %edi</span><br><span class="line">	pop %esi</span><br><span class="line">	pop %ebx</span><br><span class="line">	ret $8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_local_unwind_eh:</span><br><span class="line">	mov 4(%esp),%ecx</span><br><span class="line">	testl $6,4(%ecx)</span><br><span class="line">	mov $1,%eax</span><br><span class="line">	jz _lueh_ret</span><br><span class="line">// dispatcher = frame</span><br><span class="line">	mov 8(%esp),%eax</span><br><span class="line">	mov 16(%esp),%edx</span><br><span class="line">	mov %eax,(%edx)</span><br><span class="line">	mov $3,%eax</span><br><span class="line">_lueh_ret:</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>
<p>并重写我们的宏：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _TCCSEH_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _TCCSEH_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NULL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NULL ((void *)0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _WINBASE_</span></span><br><span class="line"><span class="type">void</span> __stdcall <span class="title function_">RaiseException</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> dwExceptionCode, <span class="type">unsigned</span> <span class="type">long</span> dwExceptionFlags, <span class="type">int</span> nNumberOfArguments, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> *lpArguments)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _INC_EXCPT</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> __cdecl _exception_code(<span class="type">void</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">scope</span> &#123;</span><span class="type">int</span> trylevel; <span class="type">void</span> *filter, *handler, *unwind;&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __seh_scope static struct _scope _scopetable[] =</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __scope(l,i) &#123;l, &amp;&amp;_filter ## i, &amp;&amp;_handler ## i, &amp;&amp;_unwind ## i&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __seh_begin void *_seh[6]; \</span></span><br><span class="line"><span class="meta">    asm( \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl $-1,-4(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%eax,-8(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl $_tcc_except_handler,-12(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%fs:0,%%eax;&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%eax,-16(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%esp,-24(%%ebp);&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;leal -16(%%ebp),%%eax;&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl %%eax,%%fs:0;&quot;</span>: :<span class="string">&quot;a&quot;</span>(_scopetable));</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __seh_end asm( \</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;movl -16(%%ebp),%%eax;movl %%eax,%%fs:0;&quot;</span>: : :<span class="string">&quot;eax&quot;</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __try asm(<span class="string">&quot;incl -4(%ebp)&quot;</span>); do</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __except(i,f...) while(0); __leave(i); \</span></span><br><span class="line"><span class="meta">    _filter ## i: \</span></span><br><span class="line"><span class="meta">    asm(<span class="string">&quot;ret&quot;</span>: :<span class="string">&quot;a&quot;</span>((&#123;f;&#125;))); \</span></span><br><span class="line"><span class="meta">    _handler ## i: asm(<span class="string">&quot;push %0&quot;</span>: :<span class="string">&quot;r&quot;</span>(&amp;&amp;_end ## i)); do</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __finally(i) while (0); \</span></span><br><span class="line"><span class="meta">    _unwind ## i: do</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __end(i) while(0); asm(<span class="string">&quot;ret&quot;</span>); _end ## i: ;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __leave(i) asm(<span class="string">&quot;decl -4(%%ebp);push %0&quot;</span>: :<span class="string">&quot;r&quot;</span>(&amp;&amp;_end ## i)); goto _unwind ## i</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EF_EXECUTE (-1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EF_SEARCH 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EF_HANDLE 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> throw(code) RaiseException(code, 0, 0, NULL)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __catch(i,code) __except(i,_exception_code() == (code) ? EF_HANDLE : EF_SEARCH)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>而这便是全部了。</p>
<h2 id="更简单的seh宏"><a class="markdownIt-Anchor" href="#更简单的seh宏"></a> 更简单的SEH宏</h2>
<p>事实上，用VC的实现思路来写SEH宏确实太麻烦了，我想没人会去用如此麻烦的宏。因此，我们重新调整思路，只是简单地使用<code>__try1</code>和<code>__except1</code>来实现SEH扩展。</p>
<p>注意到，让我们前文写的宏变得相当麻烦的就是scopetable的实现。然而，实现SEH完全不需要scopetable，我们完全可以用顺序或嵌套的<code>__try1</code>和<code>__except1</code>来实现对应的功能。此外，我们实现<code>try-catch-finally</code>，而非<code>try-except-finally</code>，因为except需要一个filter函数，不如用若干个catch来的方便。</p>
<p>我们先给出实现，然后再进行讲解。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NDEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _TCC_SEH_PROLOG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _TCC_SEH_EPILOG</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _TCC_SEH_PROLOG asm(<span class="string">&quot;pushl %ebx&quot;</span>);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _TCC_SEH_EPILOG asm(<span class="string">&quot;popl %ebx&quot;</span>);</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __seh(try, xcpt, fin) do &#123; \</span></span><br><span class="line"><span class="meta">	__label__ _l_finally, _l_except, _l_end; \</span></span><br><span class="line"><span class="meta">	const void *_ll = &amp;&amp;_l_except; int _code = 0, _mode = 0; \</span></span><br><span class="line"><span class="meta">	_TCC_SEH_PROLOG __try1(_ll) asm(<span class="string">&quot;pushl %esp; pushl %ebp&quot;</span>); \</span></span><br><span class="line"><span class="meta">	try \</span></span><br><span class="line"><span class="meta">	asm(<span class="string">&quot;add $8, %esp&quot;</span>); \</span></span><br><span class="line"><span class="meta">	_l_finally: fin \</span></span><br><span class="line"><span class="meta">	<span class="keyword">if</span> (!_code) goto _l_end; \</span></span><br><span class="line"><span class="meta">	asm(<span class="string">&quot;movl $1,%eax; popl %ecx; popl %ebp; ret&quot;</span>); \</span></span><br><span class="line"><span class="meta">	_l_except: asm(<span class="string">&quot;pushl %%ebp; movl 16(%%ebp),%%eax; movl 12(%%ebp),%%ebp; pushl -4(%%ebp); movl -8(%%ebp),%%ebp; movl 176(%%eax),%%eax&quot;</span>: <span class="string">&quot;=a&quot;</span>(_code)); \</span></span><br><span class="line"><span class="meta">	switch (_code) &#123; \</span></span><br><span class="line"><span class="meta">		default: <span class="keyword">if</span> (!_mode) goto _l_finally; xcpt break; \</span></span><br><span class="line"><span class="meta">	&#125; \</span></span><br><span class="line"><span class="meta">	_code = 0; \</span></span><br><span class="line"><span class="meta">	asm(<span class="string">&quot;popl %%esp; jmp *%%edx&quot;</span>: :<span class="string">&quot;d&quot;</span>(&amp;&amp;_l_finally)); \</span></span><br><span class="line"><span class="meta">	_l_end: __except1 _TCC_SEH_EPILOG \</span></span><br><span class="line"><span class="meta">&#125; while(0);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __try</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __catch(code) break; case code:</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __catchall (_mode = 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __finally</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __throw(code) asm(<span class="string">&quot;movl %%eax,(0)&quot;</span>: : <span class="string">&quot;a&quot;</span>(code))</span></span><br></pre></td></tr></table></figure>
<p>先解释<code>__seh</code>。同样的，我们仍然需要使用一些<code>goto</code>来控制流程，但是，由于我们不需要构建scopetable，这意味着我们可以使用局部标签，从而省去为标签命名的麻烦。</p>
<p>然后，我们构造异常处理帧。注意到这里我用了两个宏<code>_TCC_SEH_PROLOG</code>和<code>_TCC_SEH_PROLOG</code>来控制是否保护<code>EBX</code>。这是因为tcc使用-run参数时会用到<code>EBX</code>，因此我们需要防止它被破坏。如果直接编译成EXE后再运行，那么这就不是必要的了。这里我使用<code>NDEBUG</code>宏来控制。我们扩展的异常处理帧的布局如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">EBP     ;-8</span><br><span class="line">ESP     ;-4</span><br><span class="line">prev    ;0</span><br><span class="line">handler ;4</span><br><span class="line">EBX     ;8, optional</span><br></pre></td></tr></table></figure>
<p>构造完毕后，我们执行try块。如果没有异常，那么会正常地来到<code>_l_finally</code>执行finally块。在此之前，我们移除栈顶的<code>EBP</code>和<code>ESP</code>，因为没有异常发生，我们不再需要异常处理帧了。为了压缩代码量，我们采用分步的方式来移除它。finally块执行完毕后，我们检查变量<code>_code</code>。<code>_code</code>用来记录错误代码，如果没有错误或者错误已经被处理，那么<code>_code</code>为零，我们直接来到<code>_l_end</code>来销毁异常处理帧。</p>
<p>否则，当执行try块出现异常时，我们来到<code>_l_except</code>。这里可能有一些令人困惑的地方。</p>
<ol>
<li>我们的异常处理例程事实上是原来函数的一部分，因此没有构造栈帧，这意味着我们不能简单地使用<code>return</code>语句返回，因为我们知道<code>return</code>在tcc的实现事实上是<code>leave; ret</code>，而<code>leave</code>指令不是我们所期待的。</li>
<li>虽然它确实是原来函数的一部分，但是需要注意，此时它是被内核函数调用的，这意味着<code>EBP</code>的值已经发生了改变，所有<code>xcpt</code>中使用的局部变量的定位都会错乱。这时就用上了我们扩展的异常处理帧，我们从中取出<code>EBP</code>来恢复异常发生前的栈帧，并将取出的<code>ESP</code>压栈（我们在销毁异常处理帧的时候需要保证<code>ESP</code>指向异常处理帧）。</li>
</ol>
<p>在这里，我们还读取了<code>context-&gt;Eax</code>的值，它被我们约定用来表示异常处理代码。然后，我们通过一个switch来检查是否有匹配的catch。如果有，我们执行<code>xcpt</code>，并将<code>_code</code>清零。然后我们弹栈取回<code>ESP</code>使得其指向异常处理帧，并跳转至<code>_l_finally</code>执行finally块。如果没有匹配的catch，那么我们来到switch的default标签，这里的<code>_mode</code>用来控制出现未捕获异常时的行为。0表示继续搜索上一层异常处理例程；1表示捕获所有异常，交由<code>xcpt</code>最前面无catch的语句处理。如果我们向上传播异常，那么先执行finally块，然后恢复<code>EBP</code>，返回<code>ExceptionContinueSearch</code>来继续搜索。</p>
<p>在end部分，我们销毁异常处理例程，从而完全销毁异常处理帧。</p>
<p><code>__try</code>和<code>__finally</code>没有任何行为。<code>__catch</code>只是简单的case标签，我们把<code>break</code>写在前面，因为<code>__catch</code>后需要跟随一个语句，而我们的宏并不打算将这个语句包含在内。<code>__catchall</code>只是设置<code>_mode</code>来控制出现未捕获异常时的行为。至于<code>__throw</code>，我们将异常代码放入<code>EAX</code>中，并有意地触发一个<code>EXCEPTION_ACCESS_VIOLATION</code>异常，让内核函数去遍历SEH链。</p>
<p>这里我们使用吧主的帖子<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>中的例子来测试：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">func_throws_9</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	__seh(</span><br><span class="line">	__try &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s: Hello, world!\n&quot;</span>, __func__);</span><br><span class="line">		__throw(<span class="number">9</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s: This line won&#x27;t be printed\n&quot;</span>, __func__);</span><br><span class="line">	&#125;, __catch(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s: exception caught: 1\n&quot;</span>, __func__);</span><br><span class="line">	&#125;, __finally &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s: finally\n&quot;</span>, __func__);</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s: This line after __try won&#x27;t be printed\n&quot;</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	__seh(</span><br><span class="line">	__try &#123;</span><br><span class="line">		__catchall;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s: Hello world!\n&quot;</span>, __func__);</span><br><span class="line">		func_throws_9();</span><br><span class="line">		__throw(<span class="number">2</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s: This line won&#x27;t be printed\n&quot;</span>, __func__);</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;<span class="built_in">printf</span>(<span class="string">&quot;!!!Uncaught exception: %d, in &lt;%s&gt;\n&quot;</span>, _code, __func__);&#125;</span><br><span class="line">	__catch(<span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s: exception caught: 2\n&quot;</span>, __func__);</span><br><span class="line">	&#125;, __finally &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s: finally\n&quot;</span>, __func__);</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>__catchall</code>的实现并不十分好。另外，由于<code>__seh</code>是个宏，因此这里会出现一些讨厌的逗号。但总体上效果是差不多的。运行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">main: Hello world!</span><br><span class="line">func_throws_9: Hello, world!</span><br><span class="line">func_throws_9: finally</span><br><span class="line">!!!Uncaught exception: 9, in &lt;main&gt;</span><br><span class="line">main: finally</span><br></pre></td></tr></table></figure>
<p>结果略有不同，这是因为在我的实现中，“兜底”逻辑由用户实现，未捕获的异常通过<code>__catchall</code>来强制捕获；而在吧主的实现中，“兜底”逻辑在内部实现，未捕获的异常在所有事务处理完毕后再进行处理。</p>
<h2 id="注册机源码及解析"><a class="markdownIt-Anchor" href="#注册机源码及解析"></a> 注册机源码及解析</h2>
<h3 id="源码"><a class="markdownIt-Anchor" href="#源码"></a> 源码</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;conio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> xlat[] = <span class="string">&quot;8n9oALN6uK+i#Z5G&gt;JFr1\&quot;xvC:c_PBld)qm;@U*~!&amp;4-?^&lt;]E0Iz%f7XOt$.p[hV&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NOP __asm__ __volatile__ (<span class="string">&quot;nop&quot;</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> *prev, tmp;</span><br><span class="line"></span><br><span class="line">EXCEPTION_DISPOSITION</span><br><span class="line"><span class="title function_">handler</span><span class="params">(PEXCEPTION_RECORD record, PEXCEPTION_REGISTRATION frame,</span></span><br><span class="line"><span class="params">	PCONTEXT context,<span class="type">void</span> *dispatcher)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (record-&gt;ExceptionCode != EXCEPTION_SINGLE_STEP &amp;&amp;</span><br><span class="line">		record-&gt;ExceptionCode != EXCEPTION_BREAKPOINT)</span><br><span class="line">		<span class="keyword">return</span> ExceptionContinueSearch;</span><br><span class="line">	DWORD old;</span><br><span class="line">	VirtualProtect(handler, <span class="number">0x1000</span>, PAGE_EXECUTE_READWRITE, &amp;old);</span><br><span class="line">	++*prev;</span><br><span class="line">	prev = record-&gt;ExceptionAddress;</span><br><span class="line">	<span class="keyword">if</span> (*prev == <span class="number">0xCC</span>)</span><br><span class="line">		*prev = tmp;</span><br><span class="line">	--*prev;</span><br><span class="line">	<span class="keyword">if</span> (*prev == <span class="number">0xE8</span>) &#123;</span><br><span class="line">		tmp = prev[<span class="number">5</span>];</span><br><span class="line">		prev[<span class="number">5</span>] = <span class="number">0xCC</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (*prev != <span class="number">0x90</span>) &#123;</span><br><span class="line">		context-&gt;EFlags |= <span class="number">0x100</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	VirtualProtect(handler, <span class="number">0x1000</span>, old, &amp;old);</span><br><span class="line">	<span class="keyword">return</span> ExceptionContinueExecution;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">gen_mc</span><span class="params">(<span class="type">char</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> info[<span class="number">4</span>];</span><br><span class="line">	__cpuid(info, <span class="number">1</span>);</span><br><span class="line">	<span class="built_in">sprintf</span>(p, <span class="string">&quot;DUCK-%08X%08X&quot;</span>, info[<span class="number">3</span>], info[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">verify</span><span class="params">(<span class="type">char</span> *mc, <span class="type">char</span> *sn)</span></span><br><span class="line">&#123;</span><br><span class="line">	__asm__ (</span><br><span class="line">		<span class="string">&quot;movl %%eax,prev;&quot;</span></span><br><span class="line">		<span class="string">&quot;pushf;popl %%eax;&quot;</span></span><br><span class="line">		<span class="string">&quot;orl $0x100,%%eax;&quot;</span></span><br><span class="line">		<span class="string">&quot;pushl %%eax;popf;&quot;</span></span><br><span class="line">		: :<span class="string">&quot;a&quot;</span>(&amp;&amp;_start));</span><br><span class="line">	_start:</span><br><span class="line">	NOP</span><br><span class="line">	<span class="type">char</span> s[<span class="number">33</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; j &lt; <span class="number">32</span>; ++j) &#123;</span><br><span class="line">		s[j] = sn[i];</span><br><span class="line">		i = i * <span class="number">5</span> + <span class="number">1</span> &amp; <span class="number">31</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	s[<span class="number">32</span>] = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> a[<span class="number">5</span>];</span><br><span class="line">	<span class="built_in">sscanf</span>(mc, <span class="string">&quot;DUCK-%08X%08X&quot;</span>, a + <span class="number">1</span>, a + <span class="number">3</span>);</span><br><span class="line">	a[<span class="number">4</span>] = <span class="number">0xDEADCAFE</span>;</span><br><span class="line">	a[<span class="number">0</span>] = <span class="number">0xdead1eaf</span>;</span><br><span class="line">	a[<span class="number">2</span>] = <span class="number">0xC0FF1DE</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *p = (<span class="type">void</span>*)a;</span><br><span class="line">	<span class="type">char</span> r[<span class="number">33</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; ++i) &#123;</span><br><span class="line">		<span class="type">int</span> a = i * <span class="number">5</span> &gt;&gt; <span class="number">3</span>, b = i * <span class="number">5</span> &amp; <span class="number">7</span>;</span><br><span class="line">		r[i] = xlat[(p[a] &gt;&gt; b | p[a + <span class="number">1</span>] &lt;&lt; (<span class="number">8</span> - b)) &amp; <span class="number">63</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	r[<span class="number">32</span>] = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> i = !<span class="built_in">strcmp</span>(r, s);</span><br><span class="line">	NOP</span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	__try1(handler)</span><br><span class="line">	<span class="type">char</span> mc[<span class="number">73</span>];</span><br><span class="line">	gen_mc(mc);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;machine code: %s&quot;</span>, mc);</span><br><span class="line">	<span class="type">char</span> sn[<span class="number">103</span>];</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;\ninput sn code:&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%97s&quot;</span>, sn);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%scorrect&quot;</span>, (verify(mc, sn) &lt;&lt; <span class="number">1</span>) + <span class="string">&quot;in&quot;</span>);</span><br><span class="line">	__except1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解析"><a class="markdownIt-Anchor" href="#解析"></a> 解析</h3>
<p>我们这样实现加密：将每条指令的首字节加1。<br />
首先我们用tcc自带的<code>__try1</code>来把<code>handler</code>作为我们的异常处理例程。<br />
随后调用<code>gen_mc</code>来生成机器码，<code>gen_mc</code>只是简单地用<code>cpuid</code>指令获取cpu的信息，并将其作为机器码。<br />
之后输入<code>sn</code>，并调用<code>verify</code>来检验<code>sn</code>是否正确。<br />
<code>verify</code>在一开始把全局变量<code>prev</code>赋值为<code>_start</code>标签的地址。这不是必要的，但是不初始化<code>prev</code>的话需要在<code>handler</code>加上一个<code>prev==NULL</code>的特判。<br />
然后修改标志寄存器，将<code>TF</code>位置1。tcc不认识<code>pushfd/popfd</code>，要写成<code>pushf/popf</code>。<br />
因为<code>popfd</code>后不会立刻产生单步中断。我们学过8086，都知道如果当执行某条指令前，<code>TF</code>为1，那么会在执行这条指令后自动插入一条<code>int1</code>，产生一个单步中断。cpu根据IVT跳到相应的ISR，ISR用<code>iret</code>返回。<br />
因此，我们需要在加密指令前插入一条空指令，以保证在执行加密指令前产生单步中断。<br />
在执行<code>nop</code>后，由于<code>TF=1</code>，cpu插入<code>int1</code>，产生单步中断，cpu将控制权转到Ring 0的一个内核函数处理，它遍历SEH链分发单步异常，我们的异常处理例程<code>handler</code>接受并处理异常。<br />
接下来我们看<code>handler</code>。倘若不是单步异常或者断点异常，那么我们就不处理。<br />
否则，用<code>VirtualProtect</code>将.text段的属性改为可写，将<code>prev</code>（前一条指令）的首字节加1实现加密。<br />
然后我们获取异常发生的地址，即下一条指令的地址，并更新<code>prev</code>。同理我们减1来实现解密。<br />
最后，再用<code>VirtualProtect</code>将.text段的属性改为只读。<br />
注意，由于<code>context</code>的<code>EFlags</code>成员的TF位为0，所以我们要手动将其置1。如果我们遇到了<code>nop</code>，那么就结束动态加解密。<br />
但是，我们在这里面调用了库函数，而库函数是没有被加密的，所以，在调用库函数时，<code>TF</code>必须复位。我们在<code>call</code>的后面插一个<code>int3</code>，并用<code>tmp</code>保存我们破环的指令的首字节。当库函数执行完毕，产生断点异常，我们再把<code>tmp</code>写回下一条指令。<br />
<code>main</code>的最后用<code>__except1</code>来移除我们构造的SEH结点。</p>
<h2 id="参考文献"><a class="markdownIt-Anchor" href="#参考文献"></a> 参考文献</h2>
<hr class="footnotes-sep" />
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>Matt Pietrek. (1997, January). A Crash Course on the Depths of Win32™ Structured Exception Handling. Microsoft Systems Journal. <a target="_blank" rel="noopener" href="http://www.microsoft.com/msj/0197/Exception/Exception.aspx">http://www.microsoft.com/msj/0197/Exception/Exception.aspx</a>. Archive: <a target="_blank" rel="noopener" href="https://bytepointer.com/resources/pietrek_crash_course_depths_of_win32_seh.htm">A Crash Course on theDepths of Win32 Structured Exception Handling, MSJ January 1997 (bytepointer.com)</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>GTA小鸡. (2023, August 19). setjmp/longjmp实现简单的异常处理. C语言吧, Baidu Tieba. <a target="_blank" rel="noopener" href="https://tieba.baidu.com/p/8559540058">https://tieba.baidu.com/p/8559540058</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://ductory.github.io/2023/11/19/%E8%AE%A9tcc%E7%94%A8%E4%B8%8ASEH/" data-id="clxzar538000leof58vi473gq" data-title="让tcc用上SEH" class="article-share-link">Share</a>
      
      
        <a href="/2023/11/19/%E8%AE%A9tcc%E7%94%A8%E4%B8%8ASEH/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2023/11/19/%E8%AE%A9tcc%E7%94%A8%E4%B8%8ASEH/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  
    <a class="article-view-link">
      <span id="busuanzi_value_page_pv"></span>
      Times
    </a>
  
  

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C</a></li></ul>

    </footer>
  </div>
  
    
      <div id="toc" style="visibility:hidden">
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text"> 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#seh%E7%AE%80%E4%BB%8B"><span class="toc-text"> SEH简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8tcc%E8%87%AA%E5%B8%A6%E7%9A%84seh"><span class="toc-text"> 使用tcc自带的SEH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95seh"><span class="toc-text"> 扩展SEH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BAtcc%E7%BC%96%E5%86%99try-except%E6%89%A9%E5%B1%95"><span class="toc-text"> 为tcc编写try-except扩展</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E4%B8%8Afinally"><span class="toc-text"> 加上finally</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E7%AE%80%E5%8D%95%E7%9A%84seh%E5%AE%8F"><span class="toc-text"> 更简单的SEH宏</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E6%9C%BA%E6%BA%90%E7%A0%81%E5%8F%8A%E8%A7%A3%E6%9E%90"><span class="toc-text"> 注册机源码及解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81"><span class="toc-text"> 源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90"><span class="toc-text"> 解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-text"> 参考文献</span></a></li></ol>
</div>
    
    
<nav id="article-nav">
  
    <a href="/2024/05/10/%E5%85%8D%E8%B4%B9%E7%9A%84%E9%BB%84%E6%B2%B9%E7%BD%91%E7%AB%99%E5%88%86%E4%BA%AB/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          免费的黄油网站分享
        
      </div>
    </a>
  
  
    <a href="/2023/10/25/%E6%B5%85%E8%B0%88%E4%B8%80%E4%BA%9B%E6%9C%89%E8%B6%A3%E7%9A%84%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E7%AE%97%E6%B3%95/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">浅谈一些有趣的图像处理算法</div>
    </a>
  
</nav>

  
</article>



  <section id="comments" class="vcomment">

  </section>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Data-Structure/" rel="tag">Data Structure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/" rel="tag">reverse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B5%84%E6%BA%90%E5%88%86%E4%BA%AB/" rel="tag">资源分享</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/C/" style="font-size: 20px;">C</a> <a href="/tags/Data-Structure/" style="font-size: 10px;">Data Structure</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/reverse/" style="font-size: 10px;">reverse</a> <a href="/tags/%E8%B5%84%E6%BA%90%E5%88%86%E4%BA%AB/" style="font-size: 10px;">资源分享</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/06/26/%E6%B5%85%E8%B0%88B+%E6%A0%91/">浅谈B+树</a>
          </li>
        
          <li>
            <a href="/2024/05/10/%E5%85%8D%E8%B4%B9%E7%9A%84%E9%BB%84%E6%B2%B9%E7%BD%91%E7%AB%99%E5%88%86%E4%BA%AB/">免费的黄油网站分享</a>
          </li>
        
          <li>
            <a href="/2023/11/19/%E8%AE%A9tcc%E7%94%A8%E4%B8%8ASEH/">让tcc用上SEH</a>
          </li>
        
          <li>
            <a href="/2023/10/25/%E6%B5%85%E8%B0%88%E4%B8%80%E4%BA%9B%E6%9C%89%E8%B6%A3%E7%9A%84%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E7%AE%97%E6%B3%95/">浅谈一些有趣的图像处理算法</a>
          </li>
        
          <li>
            <a href="/2023/05/01/build-your-own-blog/">浅谈个人博客搭建</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div id="toc-div" class="widget-wrap" style="visibility:hidden">
  <h3 class="widget-title">Content</h3>
  <div class="widget"></div>
</div>
  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 Dangfer<br>
      <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a></br> All website licensed under <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a></br>
      
  
  
    View <span id="busuanzi_value_site_pv"></span> times,
    <span id="busuanzi_value_site_uv"></span> visitors in total.<br>
  

      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  
<script src="https://unpkg.com/valine@latest/dist/Valine.min.js"></script>

<script>
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
        return GUEST_INFO.indexOf(item) > -1
    });
    var notify = '' == true;
    var verify = '' == true;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "7KBOykQi5QpBlpD3fdDjybuz-9Nh9j0Va",
        appKey: "3Odm0iQjCZ0FtFlNZAqACXqq",
        placeholder: "Say something...",
        pageSize:'10',
        avatar:'mm',
        lang:'zh-cn',
        serverURLs: 'https://7kboykqi.lc-cn-n1-shared.com'
    });
</script>



  
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




<script src="/js/toc.js"></script>



  
<script src="/js/search.js"></script>

  <script type="text/javascript">      
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    searchFunc(path, 'site-search-input', 'site-search-result');
  </script>

  </div>
</body>
</html>